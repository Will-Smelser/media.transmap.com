<!DOCTYPE html>
<html>
<head>
    <title>Sign Data Collection</title>

    <link rel="stylesheet" href="http://www.w3.org/StyleSheets/Core/Swiss" type="text/css">
    <link rel="stylesheet" href="/theme-jquery/jquery-ui-1.9.2.custom/css/custom-theme/jquery-ui-1.9.2.custom.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/css/jqpagination.css" />

    <script src="http://code.jquery.com/jquery-1.8.1.min.js" ></script>
    <script src="/theme-jquery/jquery-ui-1.9.2.custom/js/jquery-ui-1.9.2.custom.min.js" ></script>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRaB8SQtxaNa909sDMK8Py1etA6m1RSYg&sensor=true">
    </script>
    <script src="/js/cookie.js" ></script>
    <script src="/js/jquery.jqpagination.min.js" ></script>

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0; line-height: normal; }
        #map-canvas { height: 100%; margin-right:300px; }
        li{
            margin:0px;
            padding:0px;
            list-style: none;
        }
        h2{
            margin-top:1em;
        }
        #sign-results-wrapper{
            position:absolute;
            right:0px;
            top:0px;
            height:100%;
            width:300px;
            background-color: #EFEFEF;
            z-index: 1000;
        }
        label{cursor:pointer;}
        .img-base{
            display:inline-block;
            width:18px;
            height:18px;
            background-repeat: no-repeat;
            float:right;
            margin-right:10px;
            cursor:pointer;
        }
        .good{
            background-image:url("/images/layout/icons/accept.png");
        }
        .bad{
            background-image:url("/images/layout/icons/cancel.png");
        }
        .ui-resizable-w{
            background-color:#DDD;
        }
    </style>

</head>
<body>

<div id="sign-results-wrapper">
    <div style="padding:10px">
        <div><input type="checkbox" id="gpsOn"><label for="gpsOn"> GPS on?</label> </div>
        <div><h2>Sign Data</h2></div>
        <ul id="sign-data" class="content"></ul>
        <div class="pagination">
            <a href="#" class="first" data-action="first">&laquo;</a>
            <a href="#" class="previous" data-action="previous">&lsaquo;</a>
            <input type="text" readonly="readonly" data-max-page="40" />
            <a href="#" class="next" data-action="next">&rsaquo;</a>
            <a href="#" class="last" data-action="last">&raquo;</a>
        </div>
        <hr>
        <input type="button" id="export-btn" value="Export Local Data" />
    </div>

</div>

<div id="dialog">
    <input type="hidden" id="row-key" />
    <input type="hidden" id="row-checked" />
    <form id="row-data" style="font-size:12px"></form>
    <input type="button" id="row-data-btn" value="Save Locally" />
</div>

<div id="export">
    <textarea id="export-data" style="width:100%;height:100%"></textarea>
</div>

<div id="map-canvas"/>


</body>


<script>
    /**
     * Expects fusion table data to have the following fields:
     * name, checked
     *
     */
    var store = {
        nameUnique : 'OBJECTID_1',
        nameColumns : ['Label','POST_TYPE'],
        storage : localStorage,
        $display : $('#sign-data'),
        _check : function(){
            try {
                return 'localStorage' in window && window['localStorage'] !== null;
            } catch (e) {
                return false;
            }
        },
        jsonToStr : function(obj){
            return JSON.stringify(obj);
        },
        /* set entry in localStorage */
        setItem : function(key,obj,checked){
            obj.checked = checked;
            return this.storage.setItem(key,this.jsonToStr(obj));
        },
        /* update the attribute of an item in localStorage */
        setAttribute : function(key, attr, value){
            var obj = this.getItem(key);
            obj[attr] = value;
            this.storage.setItem(key,this.jsonToStr(obj));
        },
        /* get an item */
        getItem : function(key){
            return JSON.parse(this.storage.getItem(key));
        },
        removeItem : function(key){
            this.storage.removeItem(key);
        },

        showDialog : function(key){
            row = this.getItem(key);

            $('#row-key').val(key);
            $('#row-checked').val(row.checked);

            var $table = $(document.createElement('table'));
            var $tr = $(document.createElement('tr'))
                        .append($(document.createElement('th')).html('Field'))
                        .append($(document.createElement('th')).html('Value'));
            $table.append($tr);

            for(var x in row){
                if(x === 'checked') continue;

                var key = row[x].columnName;
                var val = row[x].value;
                var $input = $(document.createElement('input')).attr('id',key).val(val).attr('name',key);
                var $tr = $(document.createElement('tr'))
                        .append($(document.createElement('td')).html(key))
                        .append($(document.createElement('td')).html($input));
                $table.append($tr);
            }

            $('#row-data').empty().html($table);

            var ht = ($(window).height()-50);
            $('#dialog').dialog("option","height",ht).dialog('open');

        },
        saveDialog : function(){
            var result = {};
            var data = $('#row-data').serializeArray();
            for(var x in data){
                var name = data[x].name;
                var value= data[x].value;
                result[name] = {columnName:name,"value":value};
            }

            var key = $('#row-key').val();
            result.checked = ($('#row-checked').val()==='true')?true:false;

            try{
                this.setItem(key,result,result.checked);
                this.redraw();
                $('#dialog').dialog('close');
            }catch(e){
                alert('Save failed!\n'+ e);
            }
        },
        export : function(){
            var $text = $('#export-data').empty();
            var str = "{\"DATA\":[";
            var comma = "";
            this.iterate(function(key, row){
                //str += "\nrow : {\n\t";
                var temp = {};
                for(var x in row){
                    var output = {};
                    if(typeof row[x] === "object"){
                        var field = row[x].columnName;
                        var value = row[x].value;
                        /*
                        output = {
                            "field":field,"value":value
                        };*/
                        temp[field] = value;
                    }else{
                        /*
                        output = {
                            "field":x,"value":row[x]
                        }*/
                        temp[x] = row[x];
                    }
                    //temp.push(output);
                }
                str += comma+"\n\t"+JSON.stringify(temp);
                comma = ",";
                //str += "\n}";
            });
            str+="\n]\n}";

            $text.val(str);
            $('#export').dialog('open');
        },

        //track click index
        index : 99999999999,

        //pagination
        curPage : 1,
        pageSize : 5,

        //initialize
        init : function(map, marker){
            var scope = this;

            if(this.storage.length > 0)
                scope.index = this.storage.key(0);

            scope.map = map;
            scope.marker = marker;

            var size = Math.ceil(scope.storage.length/scope.pageSize);
            $('.pagination').jqPagination({
                current_page:scope.curPage,
                max_page:Math.max(1,size),
                paged: function(page){
                    store.curPage=page;
                    store.redraw(page);
                }
            });

            scope.redraw(1);

            scope.startGeoTracking();
            $('#gpsOn').change(function(){
                scope.startGeoTracking();
            });

            //set the dialog
            var ht = ($(window).height()-50);
            $('#dialog').dialog({
                title:'Point Data',autoOpen:false,
                width:400,height:ht
            });
            $('#row-data-btn').button().click(function(){scope.saveDialog.call(scope);});

            $('#export').dialog({
                title:'Result Data',autoOpen:false,
                width:'90%',height:ht
            });
            $('#export-btn').button().click(function(){scope.export.call(scope);});
        },
        geoInterval : null,
        startGeoTracking : function(){
            if($('#gpsOn:checked').length > 0){
                if(navigator.geolocation) {
                    var scope = this;

                    scope.stopGeoTracking();
                    scope.geoInterval = setInterval(function(){
                        navigator.geolocation.getCurrentPosition(function(position) {
                            var pos = new google.maps.LatLng(position.coords.latitude,
                                    position.coords.longitude);
                            scope.map.setCenter(pos);

                        }, function() {
                            alert('Failed to geolocate.');
                        });
                    },500);
                }else{
                    alert('Device does not support geolocation.');
                }
            }
        },
        stopGeoTracking : function(){
            clearInterval(this.geoInterval);
        },
        /* iterrates in reverse order */
        iterate : function(func, start, stop){
            if(typeof start == 'undefined')
                start = 0;
            if(typeof stop == 'undefined' || stop == 0)
                stop = this.storage.length;
            if(stop > this.storage.length)
                stop = this.storage.length;

            for(var i=start; i < stop; i++){
                var key = this.storage.key(i);
                func(key,this.getItem(key));
            }
        },
        _createRow : function(key, name, checked, row){
            var scope = this;

            var $cbox = $(document.createElement('input')).attr('type','checkbox').attr('id','key-'+key);
            var $div = $(document.createElement('div'));

            var $label = $(document.createElement('label')).attr('for','key-'+key).addClass('name');
            var $li = $(document.createElement('li')).attr('data-key',key);

            $label.click(function(){scope.showDialog(key,row);})

            var imgClass = checked ? 'good' : 'bad';
            var $img = $(document.createElement('span')).addClass('img-base').addClass(imgClass);


            $label.append($cbox).append(name);
            $div.append($label).append($img);
            $li.append($div);

            //add img event
            $img.click(function(){
                var key = $(this).parent().parent().attr('data-key');
                scope.setAttribute(key,'checked',!checked);
                scope.redraw();
            });

            return $li;
        },
        deleteIfExists : function(attr,value){
            var scope = this;
            this.iterate(function(key,row){
                if(row != null && typeof row[attr] != "undefined" && value === row[attr])
                    scope.removeItem(key);
            });
        },
        redraw : function(page){
            if(typeof page == "undefined")
                page = this.curPage;

            this.$display.empty();

            var obj = this;

            var start = obj.pageSize * (page-1);
            var stop = start + obj.pageSize;
            this.iterate(function(key,row){
                var str = "";
                for(var i in obj.nameColumns)
                    str += row[obj.nameColumns[i]].value + "&nbsp;&nbsp;";

                var div = obj._createRow.call(obj, key, str, row.checked, row);
                obj.$display.append(div);
            },start,stop);

            //var size = Math.ceil(obj.storage.length/obj.pageSize);
            //$('.pagination').jqPagination.call(window,'option', 'max_page', size);
            //console.log(size);
        },
        locMarker : null,
        marker : null,
        map : null
    }



    var startloc = new google.maps.LatLng(34.409191, -119.692953);
    function initialize() {
        var mapOptions = {
            center: startloc,
            zoom: 16
        };

        window.map = new google.maps.Map(document.getElementById("map-canvas"),
                mapOptions);

        layer = new google.maps.FusionTablesLayer({
            query: {
                select: 'Y',
                //from: '1mZ53Z70NsChnBMm-qEYmSDOvLXgrreLTkQUvvg'
                from: '1AX2G1_UCWwnbuNNBfzAhwfD0VptlKHPXvMVC3o4'
            },
            suppressInfoWindows : true
        });

        layer.addListener('click', function(evt){
            var latLng = evt.latLng;

            //just accessing the row content
            var id = evt.row[store.nameUnique].value;
            store.deleteIfExists(store.nameUnique,id);
            store.setItem(--store.index,evt.row,true);
            store.redraw();

            var size = Math.ceil(store.storage.length/store.pageSize);
            $('.pagination').jqPagination('option', 'max_page', size);

            store.marker.setPosition(latLng);
        });
        layer.setMap(map);

        window.marker = new google.maps.Marker({
            position: startloc,
            map: map,
            title: 'Current Sign'
        });

        store.init(map, marker);


    }
    google.maps.event.addDomListener(window, 'load', initialize);


    $(document).ready(function(){
        //setup pane
        var width = $.cookie('column-width');
        $('#map-canvas').css('margin-right',width);
        $('#sign-results-wrapper').css('width',width);

        //resize pane
        $('#sign-results-wrapper').resizable({
            handles: "w",
            stop: function(evt, ui){
                $('#map-canvas').css('margin-right',ui.size.width+'px');
                $.cookie("column-width",ui.size.width+'px');
                google.maps.event.trigger(map,'resize')
            }
        });

    });

</script>


</html>